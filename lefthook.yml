# Lefthook configuration
# Fast, powerful Git hooks manager

pre-commit:
  parallel: true
  commands:
    trailing-whitespace:
      glob: "**/*"
      exclude: "*.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico"
      run: |
        for file in {staged_files}; do
          sed -i 's/[[:space:]]*$//' "$file"
          git add "$file"
        done

    end-of-file:
      glob: "**/*"
      exclude: "*.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico"
      run: |
        for file in {staged_files}; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            tail -c1 "$file" | read -r _ || (echo >> "$file" && git add "$file")
          fi
        done

    go-vet:
      glob: "**/*.go"
      run: go vet ./...

    go-test:
      glob: "**/*.go"
      run: go test -race ./...

    gitguardian:
      skip:
        - run: '[ -z "$GITGUARDIAN_API_KEY" ]'
      run: ggshield secret scan pre-commit

commit-msg:
  commands:
    conventional:
      run: |
        # Check conventional commit format
        commit_regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?: .+'
        if ! grep -qE "$commit_regex" {1}; then
          echo "Commit message must follow conventional format:"
          echo "  <type>(<scope>)?: <description>"
          echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          exit 1
        fi

skip:
  - merge
  - rebase
